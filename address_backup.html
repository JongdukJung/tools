<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, width=device-width">
    <title>좌표를 주소로 변환</title>
    <style>
		header {padding: 10px; font-size: 20px; background: #F2F2F2;}
		article {padding: 10px; font-size: 14px;}

        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            padding: 3px;
            border: 1px solid #dadada;
        }
        td {
            padding: 3px;
            border: 1px solid #dadada;
        }
        .coordList-label{
            font-size: medium;
        }
        .mb-5{
            margin-bottom: 5px;
        }
        .mb-10{
            margin-bottom: 10px;
        }
        textarea#coordList{
            min-width: 60%;
            max-width: 60%;
            min-height: 100px;
            max-height: 200px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <header>
        <h2>좌표를 주소로 변환</h2>
    </header>
    <p>
        <button type="button" style="WIDTH: 140pt; HEIGHT: 20pt; font-size: 12px" onclick="location.href='coord.html' ">주소를 좌표로 변환 바로가기</button>
        <button type="button" style="WIDTH: 120pt; HEIGHT: 20pt; font-size: 12px" onclick="location.href='address.xlsx' ">엑셀 샘플 파일 내려받기</button>
    </p>
    <article>
        <div class="mb-10">
            <label for="coordList" class="coordList-label mb-5">좌표목록 : </label>
            <br/>
            <textarea type="text" id="coordList"></textarea>
            <button type="button" id="searchButton">검색</button>
        </div>
        <div>
            <table id="resultTable" class="mb-10">
                <colgroup>
                    <col width="10%" />
                    <col width="" />
                    <col width="" />
                    <col width="" />
                    <col width="5%" />
                </colgroup>
                <thead>
                    <tr>
                        <th>이름</th>
                        <th>위도</th>
                        <th>경도</th>
                        <th>지번주소</th>
                        
                        <th>위치표시</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="map" style="margin: 0px; width:100%; height:800px;"></div>
    </article>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3a7857a3bd564cf642a647203f178f40&libraries=services"></script>
    <script>
            document.getElementById("searchButton").addEventListener("click", searchButtonClickHandler);
            var geocoder = new kakao.maps.services.Geocoder();
/* ############ 카카오 맵 API ############ */
var mapContainer = document.getElementById('map'), // 지도를 표시할 div
   mapOption = {
    center: new kakao.maps.LatLng(37.546342, 127.192786), // 지도의 중심좌표(회사)
    level: 6 // 지도의 확대 레벨
};
var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

var mapTypeControl = new kakao.maps.MapTypeControl();
map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);
/* ############ 카카오 맵 API ############ */
        //지오코딩 결과값 출력할 테이블태그 아이디
        const TABLE_ID = "resultTable"
        //html 로드완료 이벤트 설정
        //document.addEventListener("DOMContentLoaded", contentLoadedHandler);

 //클릭한 지점 위경도 표시하기
 kakao.maps.event.addListener(map, 'click', function(mouseEvent) {        
    // 클릭한 위도, 경도 정보를 가져옵니다 
    var latlng = mouseEvent.latLng;
    var message = latlng.getLat() + ', ';
    message += + latlng.getLng();
    var resultDiv = document.getElementById('result'); 
    resultDiv.innerHTML = message;

 //   var link = 'https://map.kakao.com/link/to/목적지,'+ message;
 //   document.getElementById("link").setAttribute("href",link);

    displayMarker3(latlng);
});

// 센터이동없이 마커 표시하기
function displayMarker3(locPosition) {
    var imageSrc = 'https://jongdukjung.github.io/jongdukjung/biotope/target.png'; // 마커이미지의 주소입니다   
    var imageSize = new kakao.maps.Size(12, 12); 
    var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize); 	
	var marker = new kakao.maps.Marker({  
        map: map, 
        position: locPosition,
		image: markerImage
    }); 
    kakao.maps.event.addListener(marker, 'click', function() {
        marker.setVisible(false);
        marker = null;
    });
}  


        //검색버튼 이벤트 함수
        function searchButtonClickHandler(){
            var coordListTxt = document.getElementById("coordList").value;

            //텍스트 -> Map Array
            coordList = coordListParse(coordListTxt);
            geocodingAndResultDisplay(coordList);

        }

        //테이블로 출력
        function displaycoordList(coordList){
            var tableContainer = document.querySelector("#"+TABLE_ID+">tbody");

            console.log(coordList);
            var tableRows = "";
            for(var i in coordList){

                var lat = coordList[i].y, // 위도
                    lon = coordList[i].x; // 경도
                var locPosition = new kakao.maps.LatLng(lat, lon); // 마커가 표시될 위치를 얻어온 좌표로 생성합니다
                var text2= "'"+coordList[i].index+"'";

                tableRows +=    "<tr>"+
                                    "<td>"+coordList[i].index+"</td>"+
                                    "<td>"+coordList[i].y+"</td>"+
                                    "<td>"+coordList[i].x+"</td>"+
                                    "<td>"+coordList[i].addr+"</td>"+
                                    //"<td>"+coordList[i].roadAddr+"</td>"+
                                    "<td><button onclick='displayMarker("+lat+","+lon+")'>위치표시</button> </td>"+
                                "</tr>";
                // 지도에 출력
                var imageSrc = 'https://jongdukjung.github.io/jongdukjung/biotope/target.png';
                var imageSize = new kakao.maps.Size(12, 12); 
                var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize); 	
	              var marker = new kakao.maps.Marker({  
                    map: map, 
                    position: locPosition,
		                image: markerImage,
                })


            }
            tableContainer.innerHTML = tableRows;
        

        }




        //text -> Map Array
        function coordListParse(coordListTxt){
            var txtRows = coordListTxt.split("\n");
            var resultList = [];
            for(var i in txtRows){
                //빈 행 제거
                if(txtRows[i] == "") continue;
                
                //열 분리
                var row = {};
                const arrRow = txtRows[i].split("\t");
                row.index = arrRow[0];
                row.y = arrRow[1];
                row.x = arrRow[2];

                resultList.push(row);
            }
            return resultList;
        }

        //지오코딩 함수
        function geocodingAndResultDisplay(coordList){
            var geocoder = new kakao.maps.services.Geocoder();
            var count = 0;
            const i = 0;
            for(const i in coordList){
                console.log(coordList[i], i);
                var coords = new kakao.maps.LatLng(coordList[i].y, coordList[i].x)
                searchDetailAddrFromCoords(coords, function(result, status){
                    console.log(result, i);
                    //정상처리되었을 때
                    if(status === kakao.maps.services.Status.OK){
                        //coordList[i].roadAddr = result[0].road_address.address_name;
                        coordList[i].addr = result[0].address.address_name;
                        console.log(coordList[i],i);
                    
                    }
                    count++;

                    //일괄변환이 끝났을 때
                    if(count == coordList.length){
                        displaycoordList(coordList);
                    }
                });
            }
            
        }
   
        function searchDetailAddrFromCoords(coords, callback) {
    // 좌표로 법정동 상세 주소 정보를 요청합니다
    geocoder.coord2Address(coords.getLng(), coords.getLat(), callback);
    }

  // 마커 표시하고 센터 이동하기
function displayMarker(lat, lon) {
    var imageSrc = 'https://jongdukjung.github.io/jongdukjung/biotope/current.png';
    var imageSize = new kakao.maps.Size(12, 12); 
    var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize); 	
    var locPosition = new kakao.maps.LatLng(lat, lon);
  	var marker = new kakao.maps.Marker({  
        map: map, 
        position: locPosition,
	    	image: markerImage
    }); 
  map.setCenter(locPosition);      
}  
        
    </script>
    <p id="result"></p>
</body>
</html>